<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>–í—ã–±–æ—Ä –ø–æ–¥–∞—Ä–∫–∞</title>

<style>
:root {
  --blue: #2430b8;
  --blue-dark: #1a218f;
  --green: #1db46a;
  --bg: #f3f5fb;
  --text: #111;
  --muted: #6b7280;
}

* {
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", sans-serif;
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
}

/* ===== –°–ò–ù–Ø–Ø –®–ê–ü–ö–ê ===== */
.header {
  background: linear-gradient(180deg, #2b38d6, var(--blue));
  color: #fff;
  padding: 40px 16px 120px;
  text-align: center;
  position: sticky;
  top: 0;
  z-index: 1;
}

.header h1 {
  margin: 0;
  font-size: 22px;
}

.header p {
  margin: 8px 0 0;
  font-size: 14px;
  opacity: .85;
}

/* ===== –¢–ê–ô–ú–ï–† ===== */
.timer {
  margin-top: 16px;
  background: #fff;
  color: #111;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 999px;
  font-size: 13px;
  font-weight: 500;
}

/* ===== –ë–ï–õ–´–ô –°–õ–û–ô ===== */
.content {
  margin-top: -80px;
  padding: 24px 16px 40px;
  position: relative;
  z-index: 2;
  background: #fff;
  border-radius: 24px 24px 0 0;
  min-height: calc(100vh - 120px);
}

.card-list {
  max-width: 420px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 14px;
  background: #fff;
}

/* ===== –ö–ê–†–¢–û–ß–ö–ê –ü–û–î–ê–†–ö–ê (–û–ë–ù–û–í–õ–ï–ù–û) ===== */
.gift {
  background: #fff;
  border-radius: 18px;
  padding: 14px; 
  display: block;
  position: relative;
  cursor: pointer;
  transition: box-shadow .25s, transform .2s;
}

.gift:hover {
  box-shadow: 0 12px 30px rgba(0,0,0,.12);
  transform: translateY(-2px);
}

.gift-summary {
  display: flex;
  align-items: center;
  gap: 14px;
}

.logo {
  min-width: 92px;
  height: 56px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  color: #fff;
}

.logo.green { background: #0b2f2f; }
.logo.blue { background: #0d2d9a; }
.logo.orange { background: #111; }
.logo.yellow { background: #ffe031; color:#111; }

.gift-title {
  font-size: 14px;
  font-weight: 600;
}

.gift-icon {
  margin-left: auto;
  font-size: 20px;
  color: #cbd5e1;
  transition: color .25s;
}

.gift:hover .gift-icon {
  color: #2563eb;
}

/* ===== –°–∫—Ä—ã—Ç—ã–µ –î–µ—Ç–∞–ª–∏ –ê–∫—Ü–∏–∏ (–ù–û–í–´–ï –°–¢–ò–õ–ò) ===== */
.gift-details {
  height: 0;
  opacity: 0;
  overflow: hidden;
  /* –ê–Ω–∏–º–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å */
  transition: height 0.4s ease-in-out, opacity 0.4s ease-in-out, padding-top 0.4s ease;
  padding-top: 0;
}

/* –ö–ª–∞—Å—Å –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –¥–µ—Ç–∞–ª–µ–π */
.gift-details.open {
  opacity: 1;
  padding-top: 14px;
}

.gift-details h3 {
  font-size: 16px;
  margin: 0 0 8px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ —Ä–∞—Å–∫—Ä—ã—Ç–æ–≥–æ –±–ª–æ–∫–∞ */
.details-progress {
  height: 8px;
  background: #e2e8f0;
  border-radius: 4px;
  margin: 8px 0 16px;
}

.details-progress-bar {
  height: 100%;
  background: var(--green);
  border-radius: 4px;
}

.details-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 16px;
}

.details-users {
  display: flex;
  align-items: center;
  gap: 4px;
}

/* ===== –•–ò–¢ ===== */
.hit {
  position: absolute;
  top: -8px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--green);
  color: #fff;
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 999px;
  z-index: 11; /* –í—ã—à–µ, —á–µ–º ::before */
  display: block; /* –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –º–µ—Ç–∫–∞ –≤–∏–¥–Ω–∞ */
}

/* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ .gift, 
   —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç –∑–µ–ª–µ–Ω–æ–π —Ä–∞–º–∫–∏ */
.gift.is-hit {
    /* –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ –•–ò–¢, –¥–µ–ª–∞–µ–º –≤–µ—Ä—Ö–Ω–∏–π padding –º–µ–Ω—å—à–µ, 
       —á—Ç–æ–±—ã –∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞—Ç—å –≤—ã—Å–æ—Ç—É –ª–∏–Ω–∏–∏ */
    padding-top: 10px; 
}

.gift.is-hit::before {
    content: ''; 
    position: absolute;
    top: 0; 
    left: 0;
    width: 100%; 
    height: 4px; 
    background: var(--green, #28a745);
    border-top-left-radius: 18px; 
    border-top-right-radius: 18px;
    z-index: 10; /* –ü–æ–¥ –º–µ—Ç–∫–æ–π –•–ò–¢ */
}

/* ===== –ú–û–î–ê–õ–ö–ê (–û–°–¢–ê–í–õ–ï–ù–ê, –ù–û –ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø) ===== */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10;
}

.modal.active {
  display: flex;
}

.modal-card {
  background: #fff;
  width: 92%;
  max-width: 380px;
  max-height: 90vh;
  border-radius: 22px;
  overflow-y: auto;
  padding: 16px;
  position: relative;
}

.modal-close {
  position: absolute;
  top: 12px;
  right: 12px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #f1f5f9;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.modal h2 {
  margin-top: 8px;
  font-size: 18px;
}

.primary-btn {
  width: 100%;
  height: 48px;
  border-radius: 14px;
  background: #2430b8;
  color: #fff;
  border: none;
  font-weight: 600;
  margin-top: 14px;
}
</style>
</head>

<body>

<header class="header">
  <h1>–í—ã–±–µ—Ä–∏—Ç–µ (1) –ø–æ–¥–∞—Ä–æ–∫</h1>
  <p>–£ –≤–∞—Å –µ—Å—Ç—å 5 –º–∏–Ω—É—Ç</p>

  <div class="timer" id="timer">
    ‚è± –û—Å—Ç–∞–ª–æ—Å—å 04:59
  </div>
</header>

<section class="content">
  <div class="card-list" id="cardList">
    </div>
</section>

<div class="modal" id="modal">
  <div class="modal-card">
    <div class="modal-close" onclick="closeModal()">‚úï</div>
    <div id="modalContent">
      </div>
  </div>
</div>

<script>
// Initialize Telegram WebApp
if (window.Telegram && window.Telegram.WebApp) {
  window.Telegram.WebApp.ready();
  window.Telegram.WebApp.expand();
}

const API_BASE = window.location.origin;

/* ===== –¢–ê–ô–ú–ï–† ===== */
let time = 300000; // 5 –º–∏–Ω—É—Ç = 300000 –º—Å
const timerEl = document.getElementById('timer');

const interval = setInterval(() => {
  const minutes = Math.floor(time / 60000);
  const seconds = Math.floor((time % 60000) / 1000);
  const ms = Math.floor((time % 1000) / 10); // –¥–≤–µ —Ü–∏—Ñ—Ä—ã –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥

  const m = String(minutes).padStart(2, '0');
  const s = String(seconds).padStart(2, '0');
  const msStr = String(ms).padStart(2, '0');

  timerEl.textContent = `‚è± –û—Å—Ç–∞–ª–æ—Å—å ${m}:${s}.${msStr}`;

  if (time <= 0) {
    clearInterval(interval);
  } else {
    time -= 10;
  }
}, 10);

/* ===== –ó–ê–ì–†–£–ó–ö–ê –ö–ê–†–¢–û–ß–ï–ö ===== */
let topPromotionIds = [];

async function loadPromotions() {
  try {
    const response = await fetch(`${API_BASE}/api/promotions`);
    const data = await response.json();
    
    // Get top promotions for HIT marks
    const topResponse = await fetch(`${API_BASE}/api/top-promotions`);
    const topData = await topResponse.json();
    topPromotionIds = topData.map(p => p.id);
    
    renderPromotions(data.promotions);
  } catch (error) {
    console.error('Error loading promotions:', error);
    document.getElementById('cardList').innerHTML = '<div style="text-align:center;padding:40px;color:#6b7280;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–∞—Ä–∫–æ–≤</div>';
  }
}

function renderPromotions(promotions) {
  const cardList = document.getElementById('cardList');
  if (promotions.length === 0) {
    cardList.innerHTML = '<div style="text-align:center;padding:40px;color:#6b7280;">–ü–æ–¥–∞—Ä–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
    return;
  }
  
  cardList.innerHTML = promotions.map(promo => {
    const isHit = topPromotionIds.includes(promo.id);
    const logoClass = ['green', 'blue', 'orange', 'yellow'][promo.id % 4];
    const logoText = promo.title.substring(0, 4).toUpperCase();
    
    let logoHtml = '';
    if (promo.preview_image_file_id) {
      logoHtml = `<img src="${API_BASE}/api/image/${promo.preview_image_file_id}" 
        style="width:92px;height:56px;border-radius:12px;object-fit:cover;" 
        onerror="this.outerHTML='<div class=\\'logo ${logoClass}\\'>${logoText}</div>'">`;
    } else {
      logoHtml = `<div class="logo ${logoClass}">${logoText}</div>`;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: span.hit –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ .gift, –Ω–æ –≤–Ω–µ .gift-summary
    return `
      <div class="gift ${isHit ? 'is-hit' : ''}" data-promo-id="${promo.id}" onclick="togglePromotionDetails(${promo.id})">
        ${isHit ? '<span class="hit">–•–ò–¢</span>' : ''} 
        
        <div class="gift-summary">
          ${logoHtml}
          <div class="gift-title">${promo.title}</div>
          <div class="gift-icon">üéÅ</div>
        </div>

        <div class="gift-details" id="details-${promo.id}">
          </div>
      </div>
    `;
  }).join('');
}

/* ===== –§–£–ù–ö–¶–ò–ò –ú–û–î–ê–õ–ö–ò (–ù–ï –ò–°–ü–û–õ–¨–ó–£–Æ–¢–°–Ø, –ù–û –û–°–¢–ê–í–õ–ï–ù–´) ===== */
function closeModal() {
  document.getElementById('modal').classList.remove('active');
}

/* ===== –†–ê–°–ö–†–´–¢–ò–ï –î–ï–¢–ê–õ–ï–ô –ê–ö–¶–ò–ò (–ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê) ===== */
async function togglePromotionDetails(promoId) {
  const detailsEl = document.getElementById(`details-${promoId}`);
  const giftCardEl = detailsEl.closest('.gift');
  const isCurrentlyOpen = detailsEl.classList.contains('open');

  // --- 1. –õ–æ–≥–∏–∫–∞ –ó–ê–ö–†–´–¢–ò–Ø ---
  if (isCurrentlyOpen) {
    // –°–Ω–∞—á–∞–ª–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –≤ 0
    detailsEl.style.height = '0px';
    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –∏ –æ—Ç—Å—Ç—É–ø–∞
    detailsEl.classList.remove('open');
    return;
  }
  
  // --- 2. –õ–æ–≥–∏–∫–∞ –û–¢–ö–†–´–¢–ò–Ø ---
  
  // –ê) –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
  document.querySelectorAll('.gift-details.open').forEach(el => {
    el.style.height = '0px';
    el.classList.remove('open');
  });

  // –ë) –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (View)
  let userId = null;
  if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
    userId = window.Telegram.WebApp.initDataUnsafe.user?.id;
  }
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å "–≤ —Ç–∏—Ö—É—é" (–Ω–µ –∂–¥–µ–º –æ—Ç–≤–µ—Ç–∞, —á—Ç–æ–±—ã –Ω–µ —Ç–æ—Ä–º–æ–∑–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é)
  fetch(`${API_BASE}/api/promotions/${promoId}/click`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({action: 'view', user_id: userId})
  }).catch(err => console.error('Error tracking view:', err));


  // –í) –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–µ—Ç ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º
  if (detailsEl.innerHTML.trim() === '') {
    // –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞—á–∞–ª —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å—Å—è
    detailsEl.innerHTML = '<div style="text-align:center;color:#6b7280; padding:10px 0;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    detailsEl.classList.add('open');
    // –°—Ç–∞–≤–∏–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É –¥–ª—è –ª–æ–∞–¥–µ—Ä–∞
    detailsEl.style.height = detailsEl.scrollHeight + "px";
    
    try {
      const response = await fetch(`${API_BASE}/api/promotions/${promoId}`);
      const promo = await response.json();

      const progressValue = promo.progress_percentage || 80;
      const usersClaimed = promo.users_claimed || (Math.floor(Math.random() * 15000) + 200);
      
      let mediaHtml = '';
      if (promo.image_file_id) {
        mediaHtml = `<img src="${API_BASE}/api/image/${promo.image_file_id}" 
          style="width:100%;border-radius:12px;margin-bottom:12px;max-height:300px;object-fit:cover;" 
          onerror="this.style.display='none'">`;
      }

      // –í—Å—Ç–∞–≤–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
      detailsEl.innerHTML = `
        ${mediaHtml}
        
        <div style="font-size:12px; font-weight: 500; color: ${progressValue < 100 ? 'var(--green)' : 'var(--blue-dark)'}; margin-bottom: 4px;">
          ${progressValue < 100 ? 'üî• –í—ã –ø–æ—á—Ç–∏ —É —Ü–µ–ª–∏! –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫"' : 'üéâ –ê–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!'}
        </div>
        <div class="details-progress">
          <div class="details-progress-bar" style="width:${progressValue}%;"></div>
        </div>

        <div class="details-info">
          <div class="details-users">
            üë§ ${usersClaimed.toLocaleString('ru-RU')} —á–µ–ª–æ–≤–µ–∫ —Å–µ–≥–æ–¥–Ω—è –≤—ã–±—Ä–∞–ª–∏ –ø–æ–¥–∞—Ä–æ–∫
          </div>
          <div class="details-update">
            ‚ö°Ô∏è –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ
          </div>
        </div>
        
        <p style="font-size:14px; color:#111; margin:0 0 16px; line-height:1.5;">${promo.description}</p>
        
        <button class="primary-btn" onclick="claimPromotion(${promoId}, '${promo.link}')">
          –ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫
        </button>
      `;
      
      // === –ì–õ–ê–í–ù–´–ô –ú–û–ú–ï–ù–¢ –ê–ù–ò–ú–ê–¶–ò–ò ===
      // –ü–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É
      // –î–æ–±–∞–≤–ª—è–µ–º padding-top (14px) –∫ –≤—ã—Å–æ—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
      const newHeight = detailsEl.scrollHeight; 
      detailsEl.style.height = newHeight + "px";

    } catch (error) {
      console.error('Error loading details:', error);
      detailsEl.innerHTML = '<div style="text-align:center;padding:10px;color:#ef4444;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π</div>';
      detailsEl.style.height = detailsEl.scrollHeight + "px";
    }
  } else {
    // –ì) –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç —É–∂–µ –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω —Ä–∞–Ω–µ–µ
    detailsEl.classList.add('open');
    // –ü—Ä–æ—Å—Ç–æ —Å—Ç–∞–≤–∏–º –≤—ã—Å–æ—Ç—É —Ä–∞–≤–Ω–æ–π –≤—ã—Å–æ—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
    detailsEl.style.height = detailsEl.scrollHeight + "px";
  }
  
  // –°–∫—Ä–æ–ª–ª –∫ —ç–ª–µ–º–µ–Ω—Ç—É
  setTimeout(() => {
    giftCardEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 400); 
}

async function claimPromotion(promoId, link) {
  try {
    // Get user ID from Telegram WebApp if available
    let userId = null;
    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe) {
      userId = window.Telegram.WebApp.initDataUnsafe.user?.id;
    }
    
    // Log the redirect click
    await fetch(`${API_BASE}/api/promotions/${promoId}/click`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({action: 'redirect', user_id: userId})
    });
    
    // Redirect to the promotion link
    window.open(link, '_blank');
  } catch (error) {
    console.error('Error logging click:', error);
    // Still redirect even if logging fails
    window.open(link, '_blank');
  }
}


// Load promotions on page load
loadPromotions();
</script>

</body>
</html>